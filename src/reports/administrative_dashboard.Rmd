---
title: "Administrative summary"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    smooth_scroll: true
---

```{r setup, include=FALSE}
library(flexdashboard)
library(plotly)
library(tidyr)
library(dplyr)
library(purrr)
library(DT)
library(shiny.semantic)
library(shiny)
library(htmltools)
library(crosstalk)
```

```{r layout, include=FALSE}
plot_colors <- c('#5A0A69', '#62B200')

bar_plot_margins <- list(
  l = 50,
  r = 50,
  b = 100,
  t = 10,
  pad = 4
)
```


<style>                     
.navbar {
  background-color:#5A0A69;
  border-color:black;
}
</style>  

Row {data-height=100}
-------------------------------------

```{r}
uicard <- function(header, meta, description) {
  div(class = "ui fluid cards",
  div(class = "red card",
    div(class = "content",
        div(class = "header", header),
        div(class = "meta", meta),
        div(class = "description", description))))
}

uirender(uicard("KPI 1", "XYZ", "Description"))
uirender(uicard("KPI 2", "XYZ", "Description"))
uirender(uicard("KPI 3", "XYZ", "Description"))
uirender(uicard("KPI 4", "XYZ", "Description"))
```

```{r}
load("../assets/admin_report_input.RData")
source("../plots/ploting.R")
source("../munging/munging.R")
```

Row
-------------------------------------

### Central level reporting completeness and timeliness 

```{r}
last_12_weeks_report_status <- admin_report_input$reportingValues_W12 %>%
  round_review_report()

last_12_weeks_level_2 <- last_12_weeks_report_status %>%
  dplyr::filter(level == 1) %>%
  mutate(
    year = ifelse(week < 8, 2018, 2017), # This is temporary - year column needs to be in the raw data
    year_week = paste(year, week)) %>%
  select(Id_Site, year_week, week, compReport, timeReport, reference)

last_12_weeks_level_1_long <- last_12_weeks_level_2 %>%
  gather(key = label, value = number, -Id_Site, -year_week, -week, -reference) %>%
  mutate(label = recode_report(label))

last_12_weeks_level_1_long %>%
    plot_reporting_central_level(plot_colors)
```


Row
-------------------------------------
### Overall reporting completeness/timeliness from last 12 weeks

```{r}
overall_12_weeks_report_status <- admin_report_input$reportingValues_W12_overall %>%
  round_review_report()

first_intermediate_level <- overall_12_weeks_report_status$level %>% max()

parent_sites <- overall_12_weeks_report_status %>%
  dplyr::filter(level == first_intermediate_level) %>%
  select(compReport, timeReport, Id_Site, reference, FK_ParentId) %>% 
  gather(key = label, value = number, -Id_Site, -reference, -FK_ParentId) %>%
  mutate(label = recode_report(label),
         parent_label = factor(paste(FK_ParentId, label, sep = "_"))) %>%
  arrange(parent_label)

order_sites <- unique(parent_sites$parent_label)

parent_sites %>%
  plot_1st_itermediate_level(plot_colors = plot_colors,
                             margins = bar_plot_margins,
                             order_x = order_sites,
                             x_title = 'Sites at the first intermediate level',
                             y_title = 'Reporting <br> completeness/timeliness[%]')
```

### Overall review completeness/timeliness from last 12 weeks

```{r}
reviewing_sites <- overall_12_weeks_report_status %>%
  filter(level <= first_intermediate_level)

reviewing_sites_long <- reviewing_sites %>%
  select(compReview, timeReview, level, reference) %>% 
  gather(key = label, value = number, -reference, -level) %>%
  mutate(label = recode_review(label)) %>%
  arrange(level)

order_sites_review <- unique(reviewing_sites_long$reference)

reviewing_sites_long %>% 
  plot_1st_itermediate_level(plot_colors = plot_colors,
                             margins = bar_plot_margins,
                             order_x = order_sites_review,
                             x_title = 'Sites from central level to the first intermediate level',
                             y_title = 'Reviewing <br> completeness/timeliness[%]')
```


Row
-------------------------------------

### Reporting sites without any report received for 3 weeks and longer

```{r}
sites_no_report_3weeks <- admin_report_input$noReport_W3 %>%
  mutate(is_above_3 = TRUE)

sites_no_report_8weeks <- admin_report_input$noReport_W8 %>%
  mutate(is_above_8 = TRUE)

sites_no_report <- sites_no_report_3weeks %>%
  full_join(sites_no_report_8weeks) %>%
  rename(`Parent Site Id` = Id_parentSite,
         `Parent Site Name` = name_parentSite,
         `Site Name` = siteName,
         Contact = contact,
         Phone = phone)

shared_sites_no_report <- SharedData$new(sites_no_report)
bscols(widths = c(2,NA),
  list(
    filter_checkbox("no_report_weeks", "No report for 8 weeks and longer:", shared_sites_no_report, 
                    ~ifelse(is_above_8, "Yes", "No"), inline = TRUE)
  ),
  datatable(data = shared_sites_no_report, extensions = 'Buttons',
          options = list(
            columnDefs = list(list(visible = FALSE, targets = c(6, 7))),
            dom = 'tpB', buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
)


```
